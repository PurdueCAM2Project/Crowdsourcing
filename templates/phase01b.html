{% extends 'base.html' %}
{% load static %}
{% block css %}
<link rel="stylesheet" href="{% static "css/phase01.css" %}">
{% endblock %}

{% block content %}
    <div class="container" style="padding-top: 50px">

    <div class="row">
    <h2> Q&A Validation
        <button class="btn btn-info" data-toggle="modal" data-target="#myModal">How to Play?</button>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#agreement">Instruction</button>
    </h2>
    </div>

        <!-- The Modal -->
    <div class="modal fade" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content" style="width: 250%; margin-left: -400px;margin-top: 80px">
                <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">

                    <ol class="carousel-indicators">
                        {% for inst in instructions %}
                            {% if forloop.counter == 0 %}
                                <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
                            {% else %}
                                <li data-target="#carouselExampleIndicators" data-slide-to="{{ forloop.counter }}"></li>
                            {% endif %}
                        {% endfor %}
                    </ol>

                    <div class="carousel-inner">
                        {% for inst in instructions %}
                            {% if forloop.counter0 == 0 %}
                                <div class="carousel-item active">
                                    <img src="{{ inst.imglink }}" class="d-block w-100" alt="phase01">
                                    <div class="bg-secondary text-center">
                                        <a style="font-size: 150%">{{ inst.instruction }}</a>
                                    </div>
                                </div>
                            {% else %}
                                <div class="carousel-item">
                                    <img src="{{ inst.imglink }}" class="d-block w-100" alt="phase01">
                                    <div class="bg-secondary text-center">
                                        <a style="font-size: 150%">{{ inst.instruction }}</a>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>

                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

    <!-- Button trigger modal -->

    <!-- Modal -->
    <div class="modal fade" id="agreement" tabindex="-1" role="dialog" aria-labelledby="agreement" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalScrollableTitle" style="color: black">Instruction</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="color: black">
                    Our program is focusing on training a better machine learning model of object detection. We collect questions and answers describing the feature of the images, and use the human intelligence to reduce the bias in the image dataset.
                    <hr>
                    <h5><a style="color: red">Attention</a> : Your work will <a style="color: red"> get rejected </a>if you do not follow the instruction below.</h5>
                    <hr>
                    <ul id="instruction_list">
                         {{ text_inst.instruction|safe }}
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <hr> <!--  Divider line  -->

    <div class="row" style="padding-bottom: 30px">

        <div class="col-md-7" id="bg-image" style="padding-top: 50px">

            <!-- IMAGE SET -->
            <div class="row mt-3">
                <div class="card col text-center" style="height: 35%;">
                    <div class="card-body" >
                        <img src="{{ image_url.0 }}" id="img1" class="d-inline-block img-fluid " style="height: 140px; width: 280px">
                    </div>
                </div>
                <div class="card col text-center" style="height: 35%">
                    <div class="card-body">
                        <img src="{{ image_url.1 }}" id="img2" class="d-inline-block img-fluid" style="height: 140px; width: 280px">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="card col text-center" style="height: 35%">
                    <div class="card-body">
                        <img src="{{ image_url.2 }}" id="img3" class="d-inline-block img-fluid" style="height: 140px; width: 280px">
                    </div>
                </div>
                <div class="card col text-center" style="height: 35%">
                    <div class="card-body">
                        <img src="{{ image_url.3 }}" id="img4" class="d-inline-block img-fluid" style="height: 140px; width: 280px">
                    </div>
                </div>
            </div>
            <!-- END IMAGE SET -->

        </div>



        <div class="col-md-7" style="display: none; position: absolute" id="loading-image" alt="Loading..." >
            <img src="https://media.giphy.com/media/l0He4fJxPCbfqv7Xi/giphy.gif" style="margin-left: 100px; margin-top: 30px"/>
        </div>


        <div class="col-md-5">

            <!-- Question List  !: Need Modification - just a template example, will be a for loop in the future -->
            <div class="row">
                <div class="col mt-3 ml-3">
                    <label style="font-size: x-large">Questions List </label>
                    <i class="fa fa-bell-o ml-2"></i>Scroll down to see all questions
                    <div class="rectangle" style="width: 100%; overflow-y: auto;">
                        <div class="card-content">
                            <ul id="pre-list">
                                <br>
                                {% for preq in question_list %}
                                <li>Q: {{ preq }}<br>
                                A: <input class="form-control-sm ml-2" id = "newA{{ forloop.counter0 }}" type="text" maxlength="30">
                                <label class = "form-check-label" for="skip">
                                <input class = "form-check-inline ml-3" type="checkbox" id = "skip{{ forloop.counter0 }}">
                                Skip</label>
                                </li> <hr style="width: 90%;">
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <ul hidden id="list_answer" ></ul>
                    {% if not previewMode %}
                    <button id="nextbtn" class="btn btn-warning float-right mt-2" >Next</button>
                    {% endif %}
                    <div style="padding: 10px; text-align: center; font-size: 20px;">Round {{ request.hit.roundnums.phase01b|default:0|add:1 }} of {{ NUMROUNDS }}</div>
                    <div id="alrt"></div>
                </div>
            </div>
            <!-- End Question List -->
        </div>

        <form>
        {% csrf_token %}
        </form>
        
        <script>
        $(document).ready(function(){
            if ({{ request.hit.roundnums.phase01b|default:0 }} == 0) {
                $("#agreement").modal();
            }
        });
        </script>
    
        <script>

        var flag = 0;

        var dict = {}
            var resultArr = {
                "dict" : {},
            }
		var qs = {{ question_list|safe }};
        // Function that create the dictionary for QA pairs
        function rank(){
            for (var i = 0; i < qs.length; i++) {
                if(document.getElementById("skip"+i).checked == true){
                    resultArr['dict'][qs[i]] = " ";
                }
                else{
                    resultArr['dict'][qs[i]] = document.getElementById("newA"+i).value;
                }
            }
            resultArr['dict']= JSON.stringify(resultArr['dict']);
        }

        function checkEmpty(){
            for (var q = 0; q < qs.length; q++) {
                //console.log(q);
                if(document.getElementById("skip"+q).checked == false && document.getElementById("newA"+q).value==""){
                    flag = 1;
                    // alert("Empty answer!");
                }
            }
        }
            
        //next button listener
        $('#nextbtn').click(function(event){
            //alert("New Images Inbound!")

            checkEmpty();
            // console.log(flag);
            if (flag == 0){
                rank();
                // get the value of CSRF token
                var CSRFtoken = document.getElementsByName('csrfmiddlewaretoken')[0].value;

                //post method
                $.post(window.location, {
                    'imgnum': {{ imgnum|safe }},
                    'data': resultArr,
                    csrfmiddlewaretoken : CSRFtoken
                    }, function(data){}).fail(function() {
                  alert( "An error occurred. Could not submit your data." );
                });

                // reload the webpage to set new images
                var countdown = 3000;  // your countdown in milliseconds

                //catch the error when the reloading process crashes
                try {
                    setTimeout(function () {
                        // hide your loading image after "countdown" milliseconds

                        document.getElementById("loading-image").setAttribute("style", "display:none");
                        document.getElementById("bg-image").setAttribute("style", "display:block");
                        location.reload();
                    }, countdown);
                    // show your loading image
                    document.getElementById("loading-image").setAttribute("style", "display:block");
                    document.getElementById("bg-image").setAttribute("style", "display:none");
                }
                catch(err){
                    alert(err.message);
                }
                numQA = 0;
            }
            else{
                 document.getElementById("alrt").innerHTML = "Please answer the questions!";
            }

        })
        </script>

    </div> <!-- Row -->

    </div> <!-- Container-->

{% endblock %}